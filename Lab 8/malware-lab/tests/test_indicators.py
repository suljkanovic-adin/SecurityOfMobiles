# ---------------------------------------------------------------------------
# tests/test_indicators.py  (placed under tests/)
# ---------------------------------------------------------------------------

"""Pytest smoke‑tests – run with ``pytest -q``.  The detection test is skipped
unless real APKs are present in *data/samples* to avoid CI failures.
"""

import pytest
from pathlib import Path

from scripts.common import RULES, FamilyRule, detect, load_apk


SAMPLE_DIR = Path(__file__).resolve().parent.parent / "data" / "samples"


@pytest.mark.parametrize("family", list(RULES))
def test_rules_well_formed(family):
    """Every RULES entry must be a FamilyRule instance."""
    assert isinstance(RULES[family], FamilyRule)


@pytest.mark.skipif(
    not (SAMPLE_DIR / "zniu.apk").is_file(),
    reason="real malware samples not found – skipping functional test",
)
def test_detection_smoke():
    """Ensure the ZNIU detector flags its own sample when present."""
    apk = SAMPLE_DIR / "zniu.apk"
    analysis = load_apk(apk)
    detected, _ = detect(apk.name, analysis, RULES["ZNIU"])
    assert detected is True
